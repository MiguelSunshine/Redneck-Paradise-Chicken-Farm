
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêî</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêî</text></svg>">
    <title>Chicken-App</title>
    <link rel="manifest" href='data:application/manifest+json,%7B%22name%22%3A%22Redneck%20Paradise%20-%20Chicken%20Farm%22%2C%22short_name%22%3A%22Redneck%20Paradise%20-%20Chicken%20Farm%22%2C%22display%22%3A%22standalone%22%2C%22theme_color%22%3A%22%23B48460%22%2C%22background_color%22%3A%22%23e7f7f0%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Ctext%20y%3D%27.9em%27%20font-size%3D%2790%27%3E%F0%9F%90%94%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22sizes%22%3A%22any%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D'>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg-gradient-start: #fdf8f0;
            --color-bg-gradient-end: #f8f4e8;
            --color-surface: #FFFFFF;
            --color-text-primary: #5C3D2E;
            --color-text-secondary: #8C6A47;
            --color-primary: #A0937D;
            --color-primary-hover: #897C69;
            --color-accent: #E5A044;
            --color-accent-hover: #D89133;
            --color-border: #EAE0D5;

            --bg-main: linear-gradient(to bottom right, var(--color-bg-gradient-start), var(--color-bg-gradient-end));
            --bg-card: var(--color-surface);
            --text-color: var(--color-text-primary);
            --text-color-light: var(--color-text-secondary);
            --header-bg: var(--color-text-primary);
            --header-text: #FFFFFF;
            --modal-bg: #FAF8F1;
            --modal-border: var(--color-border);
            --button-bg: var(--color-primary);
            --button-hover: var(--color-primary-hover);
            --input-border: var(--color-border);
        }

        html.dark {
            --color-bg-dark: #2C2825;
            --color-surface-dark: #3E3834;
            --color-text-primary-dark: #EAE0D5;
            --color-text-secondary-dark: #B9A89B;
            --color-primary-dark: #727964;
            --color-primary-hover-dark: #8F9779;
            --color-border-dark: #5C524B;
            --color-accent: #E5A044;
            --color-accent-hover: #D89133;

            --bg-main: var(--color-bg-dark);
            --bg-card: var(--color-surface-dark);
            --text-color: var(--color-text-primary-dark);
            --text-color-light: var(--color-text-secondary-dark);
            --header-bg: #000000;
            --header-text: #FFFFFF;
            --modal-bg: #4A443F;
            --modal-border: var(--color-border-dark);
            --button-bg: var(--color-primary-dark);
            --button-hover: var(--color-primary-hover-dark);
            --input-border: var(--color-border-dark);
        }


        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-main);
            color: var(--text-color);
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Safari */
            -khtml-user-select: none;    /* Konqueror HTML */
            -moz-user-select: none;      /* Old versions of Firefox */
            -ms-user-select: none;       /* Internet Explorer/Edge */
            user-select: none;           /* Non-prefixed version, currently supported by Chrome, Opera and Firefox */
        }
        h1, h2, h3, h4, button, label, p {
           font-family: 'Quicksand', sans-serif;
           color: inherit;
        }
        input, select, option, textarea {
            font-family: 'Quicksand', sans-serif;
            color: inherit;
            background-color: var(--bg-card);
            border-color: var(--input-border);
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            /* Verhindere Zoom auf iOS bei Input-Fokus */
            font-size: 16px !important;
        }
        /* Zus√§tzliche iOS-spezifische Optimierung f√ºr Inputs */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        .farm-header {
            background-color: var(--header-bg);
            color: var(--header-text);
        }
        .fire-text {
            color: #ffffff;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff4500, 0 0 20px #ff4500, 0 0 25px #ff4500, 0 0 30px #ff4500, 0 0 35px #ff4500;
            animation: fire-flicker 2s infinite alternate;
        }
        @keyframes fire-flicker {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff4500, 0 0 20px #ff4500, 0 0 25px #ff4500, 0 0 30px #ff4500; }
            20% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 18px #ff4500, 0 0 24px #ff4500, 0 0 30px #ff4500, 0 0 36px #ff4500; }
            40% { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #ff4500, 0 0 16px #ff4500, 0 0 20px #ff4500, 0 0 24px #ff4500; }
            60% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff4500, 0 0 20px #ff4500, 0 0 25px #ff4500, 0 0 30px #ff4500; }
            80% { text-shadow: 0 0 7px #fff, 0 0 14px #fff, 0 0 21px #ff4500, 0 0 28px #ff4500, 0 0 35px #ff4500, 0 0 42px #ff4500; }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff4500, 0 0 20px #ff4500, 0 0 25px #ff4500, 0 0 30px #ff4500; }
        }
        .card {
            background-color: var(--bg-card);
            box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            border-radius: 20px;
            border: 4px dashed transparent;
            position: relative;
            overflow: hidden;
        }
        #dashboard-grid .card {
             cursor: pointer;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 12px 12px 20px rgba(0, 0, 0, 0.15);
        }
        .modal-content {
            background-color: var(--modal-bg);
            border-color: var(--modal-border);
            border-style: dashed;
            border-width: 3px;
            border-radius: 20px;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }
        .sponsor-color-dot {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .dragging {
            opacity: 0.9 !important;
            transform: scale(1.03) rotate(2deg) !important;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3) !important;
            cursor: grabbing !important;
            z-index: 1000;
        }
        .settings-mode .card {
            cursor: grab;
        }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #image-preview-container img, .animal-list-card img, .sponsor-list-card img, .detail-image {
            object-fit: cover;
            object-position: center;
        }
        .cropper-view-box, .cropper-face { border-radius: 50%; }
        .cropper-container { max-width: 100%; max-height: 60vh; }
    </style>
</head>
<body>

    <header class="farm-header p-4 shadow-lg sticky top-0 z-40 text-center">
        <div class="container mx-auto flex justify-center items-center">
              <h1 class="text-3xl md:text-5xl font-bold tracking-wider break-words fire-text">
                  <span class="inline-block">Redneck Parad‚úäse</span> <span class="inline-block">- Chicken Farm</span>
              </h1>
        </div>
    </header>

    <nav class="bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm p-2 shadow-md sticky top-[88px] md:top-[104px] z-30">
        <div class="container mx-auto flex flex-wrap justify-center gap-2 md:gap-4">
            <button id="nav-overview" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">üè† √úbersicht</button>
            <button id="nav-animals" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">üêî Tiere</button>
            <button id="nav-sponsors" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">‚ú® Paten</button>
            <button id="nav-eggs" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">ü•ö Eier-Logbuch</button>
            <button id="nav-data" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">üíæ Daten-Management</button>
            <button id="nav-unsponsored" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">‚ùì Ohne Paten</button>
            <button id="nav-add-new" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">‚ûï Neu anlegen</button>
            <button id="nav-settings" class="bg-[var(--button-bg)] text-white font-bold py-2 px-4 rounded-full text-sm md:text-base hover:bg-[var(--button-hover)] transition-colors duration-200">‚öôÔ∏è Einstellungen</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <div id="dashboard-grid" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
            <div id="card-egg-entry" class="card p-4 sm:p-6 col-span-2">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 sm:h-7 sm:w-7"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                    T√§gliche Eier eintragen
                </h2>
                <form id="egg-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="chicken-eggs" class="block font-semibold mb-1 text-sm sm:text-base">H√ºhnereier ü•ö</label>
                        <input type="number" id="chicken-eggs" min="0" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-[var(--color-accent)]" placeholder="Anzahl">
                    </div>
                    <div>
                        <label for="duck-eggs" class="block font-semibold mb-1 text-sm sm:text-base">Enteneier ü•ö</label>
                        <input type="number" id="duck-eggs" min="0" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-[var(--color-accent)]" placeholder="Anzahl">
                    </div>
                    <button type="submit" class="w-full sm:col-span-2 bg-[var(--color-accent)] text-white font-bold py-2 px-4 rounded-full hover:bg-[var(--color-accent-hover)] transition-all duration-300 shadow-lg transform hover:-translate-y-px mt-2">Speichern</button>
                </form>
            </div>
            <div id="card-animals" class="card p-4 sm:p-6 text-center">
                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">üêî</div>
                <h3 class="text-xl sm:text-2xl font-bold">Tier√ºbersicht</h3>
                <p class="text-sm sm:text-base">H√ºhner: <span id="chicken-count">0</span></p>
                <p class="text-sm sm:text-base">Enten: <span id="duck-count">0</span></p>
            </div>
            <div id="card-sponsors" class="card p-4 sm:p-6 text-center">
                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">‚ù§Ô∏è</div>
                <h3 class="text-xl sm:text-2xl font-bold">Paten√ºbersicht</h3>
                <p class="text-sm sm:text-base">Paten gesamt: <span id="sponsor-count">0</span></p>
                <p class="text-sm sm:text-base">Aktive Paten: <span id="sponsored-animals-count">0</span></p>
            </div>
            <div id="card-unsponsored" class="card p-4 sm:p-6 flex flex-col items-center justify-center">
                <h3 class="text-xl sm:text-2xl font-bold text-center mb-2">Tiere ohne Paten</h3>
                <div class="relative w-32 h-32 sm:w-40 sm:h-40">
                    <canvas id="unsponsored-chart"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center pointer-events-none">
                        <span id="unsponsored-count-text" class="text-2xl sm:text-3xl font-bold">0</span>
                        <span class="text-xs sm:text-sm text-[var(--text-color-light)]">ohne Paten</span>
                    </div>
                </div>
            </div>
            <div id="card-eggs" class="card p-4 sm:p-6 text-center">
                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">üìú</div>
                <h3 class="text-xl sm:text-2xl font-bold">Eier Logbuch</h3>
                <p class="text-sm sm:text-base">H√ºhnereier (heute): <span id="egg-chicken-today">0</span></p>
                <p class="text-sm sm:text-base">Enteneier (heute): <span id="egg-duck-today">0</span></p>
            </div>
             <div id="card-add-new" class="card p-4 sm:p-6 text-center flex flex-col justify-center items-center">
                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">‚ûï</div>
                <h3 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-4">Neu anlegen</h3>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button id="add-animal-shortcut" class="bg-green-500 text-white font-bold py-2 px-3 text-sm sm:px-4 sm:text-base rounded-full hover:bg-green-600">Tier</button>
                    <button id="add-sponsor-shortcut" class="bg-blue-500 text-white font-bold py-2 px-3 text-sm sm:px-4 sm:text-base rounded-full hover:bg-blue-600">Pate</button>
                </div>
            </div>
             <div id="card-data" class="card p-4 sm:p-6 text-center flex flex-col justify-center items-center">
                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">üíæ</div>
                <h3 class="text-xl sm:text-2xl font-bold">Dateimanagement</h3>
                <p class="text-sm sm:text-base text-center">Daten up- & downloaden</p>
            </div>
             <div id="card-settings" class="card p-4 sm:p-6 text-center flex flex-col justify-center items-center">
                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">‚öôÔ∏è</div>
                <h3 class="text-xl sm:text-2xl font-bold">Einstellungen</h3>
                <p class="text-sm sm:text-base">Layout anpassen</p>
            </div>
        </div>
    </main>
    
    <div id="modal-container"></div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-500">
        Gespeichert!
    </div>

    <script type="module">
document.addEventListener('DOMContentLoaded', () => {
    // The global variables Chart, Cropper, and XLSX are available from the CDN scripts in index.html.

    let db;
    let activeEditSession = {};
    let activeModalObjectUrls = new Set();
    let unsponsoredChartInstance = null;
    let autoSaveTimer = null;
    
    let state = {
        animals: [],
        sponsors: [],
        eggLogs: []
    };
    
    const sponsorshipColors = {
        "Silber": "#C0C0C0",
        "Gold": "#FFD700",
        "King Edition": "#8A2BE2",
    };
    
    const funnyAnimalNames = ["Hungrige Helga", "Flotter Otto", "Gacker-Gerd", "Renn-Renate", "K√∂rner-Klaus", "Berta Br√ºtfix", "Eier-Erna", "Feder-Fritz"];
    const funnySponsorNames = ["Eier-Baron von Schnatterfeld", "K√∂rner-K√∂nigin Klara", "Der H√ºhner-Fl√ºsterer", "Gefl√ºgel-G√∂nner e.V.", "Die Feder-Freunde", "Stall-Stifter Siegfried"];

    // --- DATABASE FUNCTIONS ---
    function initDB() {
        return new Promise((resolve, reject) => {
            try {
                const request = indexedDB.open('chickenAppDB', 2);
                request.onupgradeneeded = (event) => {
                    const dbInstance = event.target.result;
                    if (!dbInstance.objectStoreNames.contains('images')) {
                        dbInstance.createObjectStore('images', { keyPath: 'id' });
                    }
                    if (!dbInstance.objectStoreNames.contains('appState')) {
                        dbInstance.createObjectStore('appState');
                    }
                    if (!dbInstance.objectStoreNames.contains('appSettings')) {
                        dbInstance.createObjectStore('appSettings');
                    }
                };
                request.onsuccess = (event) => { db = event.target.result; resolve(); };
                request.onerror = (event) => { console.error("IndexedDB error:", event.target.error); reject("Error opening IndexedDB"); };
            } catch (e) { console.error("IndexedDB could not be opened.", e); reject("IndexedDB is not available"); }
        });
    }

    function saveDataToDB(storeName, key, value) {
        return new Promise((resolve, reject) => {
            if (!db) { return reject("DB not initialized"); }
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            } catch (e) { reject(e); }
        });
    }

    function loadDataFromDB(storeName, key) {
        return new Promise((resolve, reject) => {
            if (!db) { return reject("DB not initialized"); }
            try {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            } catch (e) { reject(e); }
        });
    }

    function saveImage(id, blob) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['images'], 'readwrite');
            transaction.oncomplete = () => { console.log(`[saveImage] Transaction complete for ID: ${id}`); resolve(); };
            transaction.onerror = (event) => { console.error(`[saveImage] Transaction error for ID: ${id}`, event.target.error); reject(event.target.error); };
            const store = transaction.objectStore('images');
            store.put({ id: id, blob: blob });
        });
    }

    function getImage(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['images'], 'readonly');
            const store = transaction.objectStore('images');
            const request = store.get(id);
            request.onsuccess = (event) => resolve(event.target.result ? event.target.result.blob : null);
            request.onerror = (event) => reject(event.target.error);
        });
    }
    
    function deleteImage(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['images'], 'readwrite');
            transaction.oncomplete = () => resolve();
            transaction.onerror = (event) => reject(event.target.error);
            const store = transaction.objectStore('images');
            store.delete(id);
        });
    }

    // --- STATE MANAGEMENT ---
    const AUTO_SAVE_INTERVAL = 30000; // 30 seconds

    function startAutoSaveTimer() {
        if (autoSaveTimer) {
            clearInterval(autoSaveTimer);
        }
        autoSaveTimer = setInterval(() => {
            saveState(false); // silent auto-save
        }, AUTO_SAVE_INTERVAL);
    }

    async function saveState(showNotification = true) {
        startAutoSaveTimer(); // Reset timer on every save action
        try {
            await saveDataToDB('appState', 'mainState', state);
            if (showNotification) {
                showToast('Daten erfolgreich gespeichert!');
            }
        } catch (error) {
            console.error("Failed to save state to DB:", error);
            showAlert("Speichern fehlgeschlagen! Die Daten konnten nicht in der Datenbank gesichert werden.");
        }
    }

    async function loadState() {
        try {
            const data = await loadDataFromDB('appState', 'mainState');
            if (data) {
                state = data;
            }
        } catch (error) {
            console.error("Failed to load state from DB:", error);
            showAlert("Laden der Daten fehlgeschlagen. Die App startet m√∂glicherweise mit leeren Daten.");
        }
    }

    // --- UI & LAYOUT ---
    async function loadDashboardOrder() {
        const grid = document.getElementById('dashboard-grid');
        const allCardIdsInHtml = [...grid.querySelectorAll('.card')].map(c => c.id);
        const storedOrder = await loadDataFromDB('appSettings', 'dashboardOrder').catch(() => null);

        if (Array.isArray(storedOrder) && storedOrder.length > 0) {
            const fragment = document.createDocumentFragment();
            const orderedIds = new Set();
            const cardNodes = new Map();
            grid.querySelectorAll('.card').forEach(card => cardNodes.set(card.id, card));
            
            storedOrder.forEach(cardId => {
                if (cardNodes.has(cardId)) {
                    fragment.appendChild(cardNodes.get(cardId));
                    orderedIds.add(cardId);
                }
            });
            allCardIdsInHtml.forEach(cardId => {
                if (!orderedIds.has(cardId) && cardNodes.has(cardId)) {
                    fragment.appendChild(cardNodes.get(cardId));
                }
            });
            grid.appendChild(fragment);
        }
    }

    // --- MODAL & URL MANAGEMENT ---
    let isModalOpen = false;
    function createManagedObjectURL(blob) {
        const url = URL.createObjectURL(blob);
        activeModalObjectUrls.add(url);
        return url;
    }

    function openModal(modalContent, onOpen = null, options = {}) {
        const { stack = false } = options;
        if (isModalOpen && !stack) {
            closeModalDOM(true);
        }
        history.pushState({ modal: true, stacked: stack }, null);
        isModalOpen = true;

        const modalContainer = document.getElementById('modal-container');
        const modalWrapper = document.createElement('div');
        const existingModals = document.querySelectorAll('.modal-wrapper');
        modalWrapper.style.zIndex = (50 + (existingModals.length * 10)).toString();
        modalWrapper.className = 'modal-wrapper fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 opacity-0 transition-opacity duration-300';
        modalWrapper.innerHTML = `<div class="modal-content w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative"><button class="close-modal-btn absolute top-4 right-4 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 text-3xl z-10">&times;</button>${modalContent}</div>`;
        modalContainer.appendChild(modalWrapper);

        setTimeout(() => {
            modalWrapper.classList.remove('opacity-0');
            const contentEl = modalWrapper.querySelector('.modal-content');
            if (contentEl) contentEl.style.transform = 'scale(1)';
        }, 10);

        modalWrapper.querySelector('.close-modal-btn').addEventListener('click', () => history.back());
        modalWrapper.addEventListener('click', (e) => { if(e.target === e.currentTarget) history.back(); });
        if (onOpen) onOpen(modalWrapper);
    }

    function closeModalDOM(instant = false) {
        const allModals = document.querySelectorAll('.modal-wrapper');
        if (allModals.length === 0) {
            isModalOpen = false;
            return;
        }
        const modalWrapper = allModals[allModals.length - 1];
    
        // BUGFIX: Only clear URLs if we are closing the last modal.
        // This prevents breaking images in underlying modals (e.g., after cropping).
        if (allModals.length <= 1) {
            activeModalObjectUrls.forEach(url => URL.revokeObjectURL(url));
            activeModalObjectUrls.clear();
        }
    
        if (modalWrapper) {
            if (instant) {
                modalWrapper.remove();
            } else {
                modalWrapper.classList.add('opacity-0');
                const contentEl = modalWrapper.querySelector('.modal-content');
                if (contentEl) contentEl.style.transform = 'scale(0.95)';
                setTimeout(() => modalWrapper.remove(), 300);
            }
        }
        
        if (document.querySelectorAll('.modal-wrapper').length <= 1) {
            isModalOpen = false;
        }
    }

    window.addEventListener('popstate', () => { if (isModalOpen) closeModalDOM(); });
    
    // --- UTILITY FUNCTIONS ---
    async function generateImageHash(blob) { if (!blob) return null; const buffer = await blob.slice(0, 2048).arrayBuffer(); const uint8 = new Uint8Array(buffer); return Array.from(uint8).map(b => b.toString(16).padStart(2, '0')).join(''); }
    function getFormattedDate(date) { return date.toISOString().split('T')[0]; }
    function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.remove('opacity-0'); setTimeout(() => { toast.classList.add('opacity-0'); }, 3000); }
    function blobToBase64(blob) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); }); }
    async function base64ToBlob(base64) { const response = await fetch(base64); return await response.blob(); }
    
    async function showAlert(message) {
        return new Promise(resolve => {
            const alertWrapper = document.createElement('div');
            alertWrapper.className = 'modal-wrapper fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100] p-4';
            const content = `
                <div class="modal-content w-full max-w-sm p-6 text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="alert-ok" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                    </div>
                </div>`;
            alertWrapper.innerHTML = content;
            document.body.appendChild(alertWrapper);
            alertWrapper.querySelector('#alert-ok').addEventListener('click', () => {
                alertWrapper.remove();
                resolve();
            });
        });
    }

    async function showConfirmation(message) {
        return new Promise(resolve => {
            const confirmWrapper = document.createElement('div');
            confirmWrapper.className = 'modal-wrapper fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100] p-4';
            const content = `
                <div class="modal-content w-full max-w-sm p-6 text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-600">Nein</button>
                        <button id="confirm-ok" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600">Ja</button>
                    </div>
                </div>`;
            confirmWrapper.innerHTML = content;
            document.body.appendChild(confirmWrapper);
            confirmWrapper.querySelector('#confirm-ok').addEventListener('click', () => {
                confirmWrapper.remove();
                resolve(true);
            });
            confirmWrapper.querySelector('#confirm-cancel').addEventListener('click', () => {
                confirmWrapper.remove();
                resolve(false);
            });
        });
    }
    
    // --- UI COMPONENTS & RENDERING ---
    function renderDashboard() {
        document.getElementById('chicken-count').textContent = state.animals.filter(a => a.species === 'chicken').length.toString();
        document.getElementById('duck-count').textContent = state.animals.filter(a => a.species === 'duck').length.toString();
        document.getElementById('sponsor-count').textContent = state.sponsors.length.toString();
        document.getElementById('sponsored-animals-count').textContent = new Set(state.animals.filter(a => a.sponsorId).map(a => a.sponsorId)).size.toString();
        const todayLog = state.eggLogs.find(log => log.date === getFormattedDate(new Date())) || { chicken: 0, duck: 0 };
        document.getElementById('egg-chicken-today').textContent = todayLog.chicken.toString();
        document.getElementById('egg-duck-today').textContent = todayLog.duck.toString();

        const sponsoredCount = state.animals.filter(a => a.sponsorId).length;
        const unsponsoredCount = state.animals.length - sponsoredCount;

        document.getElementById('unsponsored-count-text').textContent = unsponsoredCount.toString();

        const ctx = document.getElementById('unsponsored-chart');
        if (ctx) {
            if (unsponsoredChartInstance) {
                unsponsoredChartInstance.destroy();
            }
            unsponsoredChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mit Pate', 'Ohne Pate'],
                    datasets: [{
                        data: [sponsoredCount, unsponsoredCount],
                        backgroundColor: ['#4ade80', '#f87171'],
                        borderColor: [ 'var(--bg-card)' ],
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true, callbacks: { label: (c) => `${c.label}: ${c.raw}` } }
                    },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }
    }

    function openCropperModal(imageSrc, onCrop) {
        let cropper;
        const content = `<h2 class="text-2xl font-bold mb-4">Bild zuschneiden</h2><div class="pb-24"><img id="cropper-image" src="${imageSrc}" style="max-width: 100%;"></div><div class="sticky bottom-0 -mx-6 -mb-6 p-4 bg-white/80 dark:bg-gray-700/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-600"><div class="text-center"><button id="crop-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600" disabled>Zuschnitt √ºbernehmen</button></div></div>`;
        
        openModal(content, (modalWrapper) => {
            const image = modalWrapper.querySelector('#cropper-image');
            const cropBtn = modalWrapper.querySelector('#crop-btn');
            
            const initCropper = () => {
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    background: false,
                    autoCropArea: 0.8,
                    dragMode: 'move',
                    ready: function () {
                        cropBtn.disabled = false;
                    }
                });
            };

            if (image.complete) {
                initCropper();
            } else {
                image.onload = initCropper;
            }

            cropBtn.addEventListener('click', () => {
                if (!cropper || !cropper.ready) return;
                
                const canvas = cropper.getCroppedCanvas({ width: 300, height: 300, imageSmoothingQuality: 'high' });
                if (canvas) {
                    canvas.toBlob((blob) => { if (blob) onCrop(blob); }, 'image/png');
                } else {
                    showAlert("Fehler: Bildausschnitt konnte nicht erstellt werden.");
                }
            });
        }, { stack: true });
    }
    
    function renderRingIndicator(animal) {
        if (!animal.ringColor || !animal.ringCount || animal.ringCount === 0) {
            return '<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Kennzeichnung: Blank</p>';
        }
        const colorMap = {
            'red': '#ef4444', 'blue': '#3b82f6', 'green': '#22c55e',
            'yellow': '#eab308', 'black': '#1f2937', 'white': '#f9fafb'
        };
        let html = '';
        for (let i = 0; i < animal.ringCount; i++) {
            html += `<div class="w-3 h-3 rounded-full border border-gray-400" style="background-color: ${colorMap[animal.ringColor] || '#9ca3af'};"></div>`;
        }
        return `<div class="flex items-center justify-center gap-1 mt-1">${html}</div>`;
    }
    
    async function createAnimalCardHTML(animal, sponsorsMap) {
        const fallbackImageUrl = `https://placehold.co/300x200/cccccc/4A2E2E?text=${encodeURIComponent(animal.name)}`;
        let imageUrl = animal.imageUrl || fallbackImageUrl;
        if (animal.hasCustomImage) {
            try {
                const blob = await getImage(animal.id);
                imageUrl = blob ? createManagedObjectURL(blob) : fallbackImageUrl;
            } catch (error) {
                console.error(`Failed to load image for animal ${animal.id}`, error);
                imageUrl = fallbackImageUrl;
            }
        }
        const sponsor = animal.sponsorId ? sponsorsMap.get(animal.sponsorId) : null;
        const borderColor = sponsor ? sponsorshipColors[sponsor.level] : '#BDC3C7';
        const sponsorName = sponsor ? sponsor.name : 'Kein Pate';

        return `
            <div class="card overflow-hidden animal-list-card" data-id="${animal.id}" style="border-color:${borderColor};">
                <img src="${imageUrl}" alt="${animal.name}" class="w-full h-40 object-cover rounded-t-lg pointer-events-none">
                <div class="p-4 pointer-events-none">
                    <h4 class="font-bold text-xl">${animal.name} (${animal.species==='chicken'?'Huhn':'Ente'})</h4>
                    ${renderRingIndicator(animal)}
                    <p class="text-sm text-gray-600 dark:text-gray-400 flex items-center justify-center mt-1">
                        <span class="sponsor-color-dot" style="background-color:${borderColor};"></span>${sponsorName}
                    </p>
                </div>
            </div>`;
    }

    async function createSponsorListItemHTML(sponsor) {
        let imageHtml;
        const fallbackImageHtml = `<div class="w-12 h-12 rounded-full mr-4 flex items-center justify-center" style="background-color: ${sponsorshipColors[sponsor.level]}"><span class="text-white font-bold text-xl">${sponsor.name.charAt(0)}</span></div>`;
        
        if (sponsor.hasCustomImage) {
            try {
                const blob = await getImage(sponsor.id);
                const url = blob ? createManagedObjectURL(blob) : null;
                imageHtml = url ? `<img src="${url}" alt="${sponsor.name}" class="w-12 h-12 object-cover rounded-full mr-4">` : fallbackImageHtml;
            } catch (error) {
                console.error(`Failed to load image for sponsor ${sponsor.id}`, error);
                imageHtml = fallbackImageHtml;
            }
        } else {
            imageHtml = fallbackImageHtml;
        }
        
        const sponsoredAnimals = state.animals.filter(a => a.sponsorId === sponsor.id);
        let sponsoredAnimalsHtml = '';
        if (sponsoredAnimals.length > 0) {
            sponsoredAnimalsHtml = `
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    <strong>Patentiere (${sponsoredAnimals.length}):</strong>
                    <span>${sponsoredAnimals.map(a => a.name).join(', ')}</span>
                </div>`;
        }

        return `
            <div class="card p-4 sponsor-list-card" data-id="${sponsor.id}" style="border-color: ${sponsorshipColors[sponsor.level]};">
                <div class="flex justify-between items-start pointer-events-none">
                    <div class="flex items-center">
                        ${imageHtml}
                        <div>
                            <h4 class="font-bold text-lg flex items-center"><span class="sponsor-color-dot" style="background-color: ${sponsorshipColors[sponsor.level]}"></span>${sponsor.name}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Modell: ${sponsor.level}</p>
                            ${sponsoredAnimalsHtml}
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function setupImageUploader(modal, saveBtn) {
        const imageInput = modal.querySelector('#image-input');
        const imagePreviewContainer = modal.querySelector('#image-preview-container');
        const takePhotoButton = modal.querySelector('#take-photo');
        const uploadPhotoButton = modal.querySelector('#upload-photo');

        if (!imageInput || !imagePreviewContainer || !takePhotoButton || !uploadPhotoButton) return;

        takePhotoButton.addEventListener('click', () => { imageInput.setAttribute('capture', 'environment'); imageInput.click(); });
        uploadPhotoButton.addEventListener('click', () => { imageInput.removeAttribute('capture'); imageInput.click(); });

        imageInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageUrl = event.target.result;
                    const crop = await showConfirmation("M√∂chtest du das Bild zuschneiden?");

                    const processBlob = async (blob) => {
                        imagePreviewContainer.innerHTML = `<img src="${createManagedObjectURL(blob)}" class="h-20 w-20 object-cover rounded-full">`;
                        activeEditSession.newImageBlob = blob;
                        saveBtn.disabled = false;
                    };
                    
                    if (crop) {
                        openCropperModal(imageUrl, (croppedBlob) => {
                            processBlob(croppedBlob);
                            history.back(); 
                        });
                    } else {
                        processBlob(file); 
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    function renderAddNewModal() {
        let content = `<h2 class="text-3xl font-bold mb-4">Was m√∂chtest du anlegen?</h2><div class="flex flex-col sm:flex-row justify-center gap-4"><button id="add-new-animal-from-modal" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600">Neues Tier üêî</button><button id="add-new-sponsor-from-modal" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-600">Neuer Pate ‚ù§Ô∏è</button></div>`;
        openModal(content, (modal) => {
            modal.querySelector('#add-new-animal-from-modal').addEventListener('click', () => renderEditAnimalModal());
            modal.querySelector('#add-new-sponsor-from-modal').addEventListener('click', () => renderEditSponsorModal());
        });
    }
    
    function renderSettingsModal() {
        const grid = document.getElementById('dashboard-grid');
        const cardsHtml = grid.innerHTML;
        const isDarkMode = document.documentElement.classList.contains('dark');
        let content = `
            <h2 class="text-3xl font-bold mb-4">Einstellungen</h2>
            <div class="flex items-center justify-between p-4 border-b border-[var(--input-border)] mb-4">
                <label for="dark-mode-toggle" class="font-semibold">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle" ${isDarkMode ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <h3 class="text-2xl font-bold mb-4">Layout anpassen</h3>
            <p class="mb-6 text-[var(--text-color-light)]">Halte eine Karte gedr√ºckt, um sie zu verschieben. Lege sie an der gew√ºnschten Position ab und klicke anschlie√üend auf "Speichern".</p>
            <div id="settings-grid" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 settings-mode pb-24">${cardsHtml}</div>
            <div class="sticky bottom-0 -mx-6 -mb-6 p-4 bg-white/80 dark:bg-gray-700/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-600">
                <div class="text-center">
                    <button id="save-layout-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600">Layout speichern</button>
                </div>
            </div>`;
        openModal(content, (modal) => {
            const settingsGrid = modal.querySelector('#settings-grid');
            initModalDraggable(settingsGrid);
            modal.querySelector('#dark-mode-toggle').addEventListener('change', toggleTheme);
            modal.querySelector('#save-layout-btn').addEventListener('click', async () => {
                const orderedIds = [...settingsGrid.querySelectorAll('.card')].map(card => card.id);
                try {
                    await saveDataToDB('appSettings', 'dashboardOrder', orderedIds);
                    await loadDashboardOrder();
                    history.back();
                    showToast('Layout erfolgreich gespeichert!');
                } catch (error) {
                    console.error("Failed to save layout:", error);
                    showAlert("Layout konnte nicht gespeichert werden.");
                }
            });
        });
    }

    function renderEggModal() {
        const totalChickenEggs = state.eggLogs.reduce((sum, log) => sum + log.chicken, 0);
        const totalDuckEggs = state.eggLogs.reduce((sum, log) => sum + log.duck, 0);
        const sortedLogs = [...state.eggLogs].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        
        const content = `
            <h2 class="text-3xl font-bold mb-4">Eier Logbuch</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-bold text-xl mb-2">Gesamtverteilung</h3>
                    <canvas id="egg-pie-chart"></canvas>
                </div>
                <div>
                    <h3 class="font-bold text-xl mb-2">Produktion √ºber Zeit</h3>
                    <canvas id="egg-line-chart"></canvas>
                </div>
            </div>
            <div class="mt-8">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-xl">Historie</h3>
                    <button id="add-past-egg-log-btn" class="bg-blue-500 text-white font-bold py-1 px-3 rounded-full text-sm hover:bg-blue-600">Nachtragen</button>
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-lg p-2">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b"><th>Datum</th><th>H√ºhnereier</th><th>Enteneier</th></tr>
                        </thead>
                        <tbody>
                            ${sortedLogs.map(l => `<tr><td>${new Date(l.date).toLocaleDateString('de-DE')}</td><td>${l.chicken}</td><td>${l.duck}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
    
        openModal(content, modal => {
            new Chart(modal.querySelector('#egg-pie-chart'), {
                type: 'pie',
                data: {
                    labels: ['H√ºhnereier', 'Enteneier'],
                    datasets: [{
                        data: [totalChickenEggs, totalDuckEggs],
                        backgroundColor: ['#FFC107', '#87CEEB']
                    }]
                }
            });
    
            const last10Logs = sortedLogs.slice(0, 10).reverse();
            const lineLabels = last10Logs.map(l => new Date(l.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }));
            const lineChickenData = last10Logs.map(l => l.chicken);
            const lineDuckData = last10Logs.map(l => l.duck);
            
            new Chart(modal.querySelector('#egg-line-chart'), {
                type: 'line',
                data: {
                    labels: lineLabels,
                    datasets: [
                        { label: 'H√ºhnereier', data: lineChickenData, borderColor: '#FFC107', tension: 0.1 },
                        { label: 'Enteneier', data: lineDuckData, borderColor: '#87CEEB', tension: 0.1 }
                    ]
                }
            });

            modal.querySelector('#add-past-egg-log-btn').addEventListener('click', renderAddPastEggLogModal);
        });
    }

    function renderAddPastEggLogModal() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const maxDate = getFormattedDate(today);
        const defaultDate = getFormattedDate(yesterday);

        const content = `
            <h2 class="text-3xl font-bold mb-4">Eier nachtragen</h2>
            <form id="past-egg-log-form" class="space-y-4">
                <div>
                    <label for="past-egg-date" class="block font-semibold mb-1">Datum</label>
                    <input type="date" id="past-egg-date" name="date" class="w-full p-2 border rounded-lg" value="${defaultDate}" max="${maxDate}" required>
                </div>
                <div>
                    <label for="past-chicken-eggs" class="block font-semibold mb-1">H√ºhnereier ü•ö</label>
                    <input type="number" id="past-chicken-eggs" name="chicken" min="0" class="w-full p-2 border rounded-lg" placeholder="Anzahl" required>
                </div>
                <div>
                    <label for="past-duck-eggs" class="block font-semibold mb-1">Enteneier ü•ö</label>
                    <input type="number" id="past-duck-eggs" name="duck" min="0" class="w-full p-2 border rounded-lg" placeholder="Anzahl" required>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600">Speichern</button>
                </div>
            </form>
        `;
        openModal(content, (modal) => {
            modal.querySelector('#past-egg-log-form').addEventListener('submit', handleAddPastEggLogSubmit);
        }, { stack: true });
    }
    
    function renderFileModal() {
        const content = `
            <h2 class="text-3xl font-bold mb-4">Dateimanagement</h2>
            <p class="mb-6">Lade deine Tier- und Patendaten als Excel-Datei herunter oder lade eine bestehende Datei hoch, um deine Daten zu aktualisieren.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-4 border rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Daten Herunterladen</h3>
                    <button id="export-data" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Daten als Excel exportieren</button>
                </div>
                <div class="p-4 border rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Daten Hochladen</h3>
                    <label for="import-file" class="w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 cursor-pointer block">Excel-Datei importieren</label>
                    <input type="file" id="import-file" class="hidden" accept=".xlsx, .xls">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Hinweis: Beim Import werden bestehende Daten √ºberschrieben. Bitte lade zuerst deine aktuellen Daten herunter, um die richtige Formatierung sicherzustellen.</p>
                </div>
            </div>
            <div class="mt-8 p-4 border-2 border-red-400 rounded-lg bg-red-50 dark:bg-red-900/20">
                <h3 class="font-bold text-lg mb-2 text-red-700 dark:text-red-300">Gefahrenzone</h3>
                <p class="mb-4 text-sm text-red-600 dark:text-red-300">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden. Alle Tier-, Paten- und Eierdaten werden dauerhaft gel√∂scht.</p>
                <button id="delete-all-data" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Alle App-Daten l√∂schen</button>
            </div>`;
        
        openModal(content, modal => {
            modal.querySelector('#export-data').addEventListener('click', exportData);
            modal.querySelector('#import-file').addEventListener('change', importData);
            modal.querySelector('#delete-all-data').addEventListener('click', deleteAllData);
        });
    }
    
    function initModalDraggable(container) {
        let draggingCard = null, longPressTimer = null, isDragging = false;
        const preventDefault = (e) => e.preventDefault();
        container.querySelectorAll('.card').forEach(card => {
            card.setAttribute('draggable', 'true');
            card.addEventListener('dragstart', () => { isDragging = true; draggingCard = card; document.addEventListener('dragover', preventDefault); setTimeout(() => card.classList.add('dragging'), 0); });
            card.addEventListener('dragend', () => { document.removeEventListener('dragover', preventDefault); if (draggingCard) draggingCard.classList.remove('dragging'); draggingCard = null; isDragging = false; });
            card.addEventListener('touchstart', () => { if (isDragging) return; draggingCard = card; longPressTimer = window.setTimeout(() => { isDragging = true; draggingCard.classList.add('dragging'); if (navigator.vibrate) navigator.vibrate(50); }, 250); }, { passive: true });
            card.addEventListener('touchend', () => { clearTimeout(longPressTimer); if (isDragging && draggingCard) { draggingCard.classList.remove('dragging'); } draggingCard = null; isDragging = false; });
            card.addEventListener('touchmove', e => { if (longPressTimer && !isDragging) clearTimeout(longPressTimer); if (isDragging && draggingCard) { e.preventDefault(); const touch = e.touches[0]; const afterElement = getDragAfterElement(container, touch.clientY); container.insertBefore(draggingCard, afterElement); } }, { passive: false });
        });
        container.addEventListener('dragover', (e) => { e.preventDefault(); if (!draggingCard) return; const afterElement = getDragAfterElement(container, e.clientY); container.insertBefore(draggingCard, afterElement); });
        container.addEventListener('drop', (e) => e.preventDefault());
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
        }
    }

    async function renderAnimalModal(options = {}) {
        const { filter = '', sponsorFilter = 'all', sortBy = 'createdAt_desc' } = options;
        const sponsorsMap = new Map(state.sponsors.map(s => [s.id, s]));
        let filteredAnimals = state.animals;

        if (sponsorFilter === 'sponsored') {
            filteredAnimals = filteredAnimals.filter(a => a.sponsorId);
        } else if (sponsorFilter === 'unsponsored' || sponsorFilter === 'none') {
            filteredAnimals = filteredAnimals.filter(a => !a.sponsorId);
        }

        if (filter) {
            const s = filter.toLowerCase();
            filteredAnimals = filteredAnimals.filter(a => {
                const sp = a.sponsorId ? sponsorsMap.get(a.sponsorId) : null;
                return a.name.toLowerCase().includes(s) || a.species.toLowerCase().includes(s) || (sp && sp.name.toLowerCase().includes(s));
            });
        }

        filteredAnimals.sort((a, b) => {
            switch (sortBy) {
                case 'name_asc': return a.name.localeCompare(b.name);
                case 'createdAt_desc': return b.createdAt - a.createdAt;
                case 'createdAt_asc': return a.createdAt - b.createdAt;
                default: return 0;
            }
        });
        const animalCardsPromises = filteredAnimals.map(animal => createAnimalCardHTML(animal, sponsorsMap));
        const animalCardsHtml = (await Promise.all(animalCardsPromises)).join('');

        const content = `
            <h2 class="text-3xl font-bold mb-4">Tier√ºbersicht</h2>
            <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                <input type="text" id="animal-search" class="w-full p-2 border rounded-lg sm:col-span-2 lg:col-span-1" placeholder="Suche..." value="${filter}">
                <select id="animal-sponsor-filter" class="w-full p-2 border rounded-lg">
                    <option value="all" ${sponsorFilter === 'all' ? 'selected' : ''}>Alle Tiere</option>
                    <option value="sponsored" ${sponsorFilter === 'sponsored' ? 'selected' : ''}>Mit Paten</option>
                    <option value="unsponsored" ${sponsorFilter === 'unsponsored' || sponsorFilter === 'none' ? 'selected' : ''}>Ohne Paten</option>
                </select>
                <select id="animal-sort" class="w-full p-2 border rounded-lg">
                    <option value="createdAt_desc" ${sortBy === 'createdAt_desc' ? 'selected' : ''}>Neueste zuerst</option>
                    <option value="createdAt_asc" ${sortBy === 'createdAt_asc' ? 'selected' : ''}>√Ñlteste zuerst</option>
                    <option value="name_asc" ${sortBy === 'name_asc' ? 'selected' : ''}>Name (A-Z)</option>
                </select>
                <button id="add-new-animal-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-full hover:bg-green-600 whitespace-nowrap">Neues Tier +</button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">${animalCardsHtml || '<p>Keine Tiere gefunden.</p>'}</div>
        `;
        openModal(content, m => {
            const searchInput = m.querySelector('#animal-search');
            const sortSelect = m.querySelector('#animal-sort');
            const sponsorFilterSelect = m.querySelector('#animal-sponsor-filter');
            
            const applyFilters = () => {
                renderAnimalModal({
                    filter: searchInput.value,
                    sortBy: sortSelect.value,
                    sponsorFilter: sponsorFilterSelect.value
                });
            };
            
            searchInput.addEventListener('input', applyFilters);
            sortSelect.addEventListener('change', applyFilters);
            sponsorFilterSelect.addEventListener('change', applyFilters);
            
            m.querySelector('#add-new-animal-btn').addEventListener('click', () => renderEditAnimalModal());
            m.querySelectorAll('.animal-list-card').forEach(c => c.addEventListener('click', (e) => renderAnimalDetailModal(parseInt(e.currentTarget.dataset.id))));
        });
    }
    
    async function renderAnimalDetailModal(animalId) {
        const animal = state.animals.find(a => a.id == animalId);
        if (!animal) return;
    
        const sponsor = animal.sponsorId ? state.sponsors.find(s => s.id === animal.sponsorId) : null;
        const borderColor = sponsor ? sponsorshipColors[sponsor.level] : '#BDC3C7';
        const ringIndicatorHtml = renderRingIndicator(animal) || '<p class="text-sm text-gray-500 mt-1">Kennzeichnung: Blank</p>';
        const sponsorInfoHtml = sponsor
            ? `<p><strong>Name:</strong> ${sponsor.name}</p><p><strong>Modell:</strong> ${sponsor.level}</p>`
            : '<p>Dieses Tier hat noch keinen Paten.</p>';
    
        const imageContainerHtml = `
            <div id="image-container-placeholder" class="relative w-48 h-48 mx-auto flex items-center justify-center bg-gray-200 dark:bg-gray-700 rounded-full">
                <span class="text-gray-500">Laden...</span>
            </div>`;

        const content = `
            <div class="text-center">
                ${imageContainerHtml}
                <h2 class="text-3xl font-bold mt-4">${animal.name}</h2>
                <div class="my-4">${ringIndicatorHtml}</div>
                <div class="text-left bg-white/50 dark:bg-gray-800/50 p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">Paten-Information</h3>
                    ${sponsorInfoHtml}
                </div>
                <div class="mt-6 flex gap-4 justify-center">
                    <button id="back-to-list-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-full">Zur√ºck</button>
                    <button id="edit-from-detail-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Bearbeiten</button>
                    <button id="delete-from-detail-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-full">L√∂schen</button>
                </div>
            </div>`;
    
        openModal(content, async modal => {
            modal.querySelector('#back-to-list-btn').addEventListener('click', () => history.back());
            modal.querySelector('#edit-from-detail-btn').addEventListener('click', () => renderEditAnimalModal(animalId));
            modal.querySelector('#delete-from-detail-btn').addEventListener('click', () => deleteAnimal(animalId, true));

            const fallbackImageUrl = `https://placehold.co/300x200/cccccc/4A2E2E?text=${encodeURIComponent(animal.name)}`;
            let imageUrl = animal.imageUrl || fallbackImageUrl;
        
            if (animal.hasCustomImage) {
                try {
                    const blob = await getImage(animal.id);
                    if (blob) {
                        imageUrl = createManagedObjectURL(blob);
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            const finalImageContainerHtml = `
                <div class="relative w-48 h-48 mx-auto">
                    <img src="${imageUrl}" alt="${animal.name}" class="detail-image w-48 h-48 object-cover rounded-full border-4" style="border-color:${borderColor}">
                    <button id="edit-image-btn" class="absolute bottom-0 right-0 bg-white dark:bg-gray-700 p-2 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-gray-700 dark:text-gray-200"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </button>
                    <input type="file" id="detail-image-input" class="hidden" accept="image/*">
                </div>`;
            
            const placeholder = modal.querySelector('#image-container-placeholder');
            if(placeholder) placeholder.outerHTML = finalImageContainerHtml;

            const imageInput = modal.querySelector('#detail-image-input');
            modal.querySelector('#edit-image-btn').addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageUrl = event.target.result;
                    const crop = await showConfirmation("M√∂chtest du das Bild zuschneiden?");

                    const processBlob = async (blob) => {
                        await saveImage(animal.id, blob);
                        animal.hasCustomImage = true;
                        delete animal.imageUrl;
                        await saveState();
                        showToast('Bild erfolgreich aktualisiert!');
                    };
                    
                    const handleBlob = async (blob, fromCropper) => {
                        try {
                            await processBlob(blob);
                            if (fromCropper) {
                                const onPopState = () => {
                                    window.removeEventListener('popstate', onPopState);
                                    setTimeout(() => renderAnimalDetailModal(animal.id), 100);
                                };
                                window.addEventListener('popstate', onPopState);
                                history.back();
                            } else {
                                renderAnimalDetailModal(animal.id);
                            }
                        } catch (error) {
                            console.error("Image update error:", error);
                            showAlert("Bild konnte nicht aktualisiert werden.");
                        }
                    };

                    if (crop) {
                        openCropperModal(imageUrl, (croppedBlob) => {
                            handleBlob(croppedBlob, true);
                        });
                    } else {
                        handleBlob(file, false);
                    }
                };
                reader.readAsDataURL(file);
            });
        });
    }

    async function renderSponsorModal(options = {}) {
        const { filter = '', sortBy = 'name_asc', levelFilter = 'alle' } = options;
        let filteredSponsors = state.sponsors;
    
        if (filter) {
            const searchTerm = filter.toLowerCase();
            filteredSponsors = filteredSponsors.filter(sp => sp.name.toLowerCase().includes(searchTerm));
        }
    
        if (levelFilter !== 'alle') {
            filteredSponsors = filteredSponsors.filter(sp => sp.level === levelFilter);
        }
    
        const levelOrder = { "King Edition": 1, "Gold": 2, "Silber": 3 };
        filteredSponsors.sort((a, b) => {
            switch (sortBy) {
                case 'name_asc':
                    return a.name.localeCompare(b.name);
                case 'level':
                    return levelOrder[a.level] - levelOrder[b.level];
                case 'animal_count':
                    const countA = state.animals.filter(an => an.sponsorId === a.id).length;
                    const countB = state.animals.filter(an => an.sponsorId === b.id).length;
                    return countB - countA;
                default:
                    return 0;
            }
        });
    
        const sponsorListPromises = filteredSponsors.map(createSponsorListItemHTML);
        const sponsorListHtml = (await Promise.all(sponsorListPromises)).join('');
    
        const content = `
            <h2 class="text-3xl font-bold mb-4">Paten√ºbersicht</h2>
            <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
                <input type="text" id="sponsor-search" class="w-full p-2 border rounded-lg sm:col-span-2 lg:col-span-1" placeholder="Suche..." value="${filter}">
                <select id="sponsor-level-filter" class="w-full p-2 border rounded-lg">
                    <option value="alle" ${levelFilter === 'alle' ? 'selected' : ''}>Alle Partnerschaften</option>
                    <option value="Silber" ${levelFilter === 'Silber' ? 'selected' : ''}>Silber</option>
                    <option value="Gold" ${levelFilter === 'Gold' ? 'selected' : ''}>Gold</option>
                    <option value="King Edition" ${levelFilter === 'King Edition' ? 'selected' : ''}>King Edition</option>
                </select>
                <select id="sponsor-sort" class="w-full p-2 border rounded-lg">
                    <option value="name_asc" ${sortBy === 'name_asc' ? 'selected' : ''}>Name (A-Z)</option>
                    <option value="level" ${sortBy === 'level' ? 'selected' : ''}>Patenschafts-Stufe</option>
                    <option value="animal_count" ${sortBy === 'animal_count' ? 'selected' : ''}>Anzahl Patentiere</option>
                </select>
                <button id="add-new-sponsor-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 whitespace-nowrap">Neuer Pate +</button>
            </div>
            <div class="space-y-3">${sponsorListHtml || '<p>Keine Paten gefunden.</p>'}</div>`;
    
        openModal(content, modal => {
            const searchInput = modal.querySelector('#sponsor-search');
            const sortSelect = modal.querySelector('#sponsor-sort');
            const levelFilterSelect = modal.querySelector('#sponsor-level-filter');
            
            const rerender = () => {
                renderSponsorModal({ filter: searchInput.value, sortBy: sortSelect.value, levelFilter: levelFilterSelect.value });
            };
            
            searchInput.addEventListener('input', rerender);
            sortSelect.addEventListener('change', rerender);
            levelFilterSelect.addEventListener('change', rerender);
            
            modal.querySelector('#add-new-sponsor-btn').addEventListener('click', () => renderEditSponsorModal());
            modal.querySelectorAll('.sponsor-list-card').forEach(c => c.addEventListener('click', (e) => renderSponsorDetailModal(parseInt(e.currentTarget.dataset.id))));
        });
    }

    async function renderSponsorDetailModal(sponsorId) {
        const sponsor = state.sponsors.find(s => s.id == sponsorId);
        if (!sponsor) return;

        const sponsoredAnimals = state.animals.filter(a => a.sponsorId === sponsor.id);
        const animalsHtml = sponsoredAnimals.length > 0
            ? `<ul>${sponsoredAnimals.map(an => `<li>- ${an.name} (${an.species === 'chicken' ? 'Huhn' : 'Ente'})</li>`).join('')}</ul>`
            : '<p>Dieser Pate hat noch keine Tiere.</p>';
            
        const imageContainerPlaceholder = `
            <div id="image-container-placeholder" class="relative w-48 h-48 mx-auto flex items-center justify-center bg-gray-200 dark:bg-gray-700 rounded-full">
                <span class="text-gray-500">Laden...</span>
            </div>`;

        const content = `
            <div class="text-center">
                ${imageContainerPlaceholder}
                <h2 class="text-3xl font-bold mt-4">${sponsor.name}</h2>
                <p class="text-lg text-gray-600 dark:text-gray-400">Modell: ${sponsor.level}</p>
                <div class="text-left bg-white/50 dark:bg-gray-800/50 p-4 rounded-lg mt-4">
                    <h3 class="font-bold text-lg mb-2">Patentiere</h3>
                    ${animalsHtml}
                </div>
                <div class="mt-6 flex gap-4 justify-center">
                    <button id="back-to-sponsor-list-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-full">Zur√ºck</button>
                    <button id="edit-sponsor-from-detail-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full">Bearbeiten</button>
                    <button id="delete-sponsor-from-detail-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-full">L√∂schen</button>
                </div>
            </div>`;
    
        openModal(content, async modal => {
            modal.querySelector('#back-to-sponsor-list-btn').addEventListener('click', () => history.back());
            modal.querySelector('#edit-sponsor-from-detail-btn').addEventListener('click', () => renderEditSponsorModal(sponsorId));
            modal.querySelector('#delete-sponsor-from-detail-btn').addEventListener('click', () => deleteSponsor(sponsorId, true));

            let imageContentHtml;
            let hasImage = false;
            if (sponsor.hasCustomImage) {
                try {
                    const blob = await getImage(sponsor.id);
                    if (blob) {
                        const url = createManagedObjectURL(blob);
                        imageContentHtml = `<img src="${url}" alt="${sponsor.name}" class="detail-image w-48 h-48 object-cover rounded-full border-4" style="border-color:${sponsorshipColors[sponsor.level]}">`;
                        hasImage = true;
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            if (!hasImage) {
                imageContentHtml = `<div class="w-48 h-48 rounded-full border-4 flex items-center justify-center" style="border-color:${sponsorshipColors[sponsor.level]};background-color:${sponsorshipColors[sponsor.level]};"><span class="text-white font-bold text-7xl">${sponsor.name.charAt(0)}</span></div>`;
            }

            const finalImageContainerHtml = `
                <div class="relative w-48 h-48 mx-auto">
                    ${imageContentHtml}
                    <button id="edit-image-btn" class="absolute bottom-0 right-0 bg-white dark:bg-gray-700 p-2 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-gray-700 dark:text-gray-200"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </button>
                    <input type="file" id="detail-image-input" class="hidden" accept="image/*">
                </div>`;
            
            const placeholder = modal.querySelector('#image-container-placeholder');
            if(placeholder) placeholder.outerHTML = finalImageContainerHtml;

            const imageInput = modal.querySelector('#detail-image-input');
            modal.querySelector('#edit-image-btn').addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const imageUrl = event.target.result;
                    const crop = await showConfirmation("M√∂chtest du das Bild zuschneiden?");

                    const processBlob = async (blob) => {
                        await saveImage(sponsor.id, blob);
                        sponsor.hasCustomImage = true;
                        await saveState();
                        showToast('Bild erfolgreich aktualisiert!');
                    };

                    const handleBlob = async (blob, fromCropper) => {
                        try {
                            await processBlob(blob);
                            if (fromCropper) {
                                const onPopState = () => {
                                    window.removeEventListener('popstate', onPopState);
                                    setTimeout(() => renderSponsorDetailModal(sponsor.id), 100);
                                };
                                window.addEventListener('popstate', onPopState);
                                history.back();
                            } else {
                                renderSponsorDetailModal(sponsor.id);
                            }
                        } catch (error) {
                            console.error("Image update error:", error);
                            showAlert("Bild konnte nicht aktualisiert werden.");
                        }
                    };

                    if (crop) {
                        openCropperModal(imageUrl, (croppedBlob) => {
                            handleBlob(croppedBlob, true);
                        });
                    } else {
                        handleBlob(file, false);
                    }
                };
                reader.readAsDataURL(file);
            });
        });
    }
    
    async function renderEditAnimalModal(animalId = null) {
        activeEditSession = {};
        const animal = animalId ? state.animals.find(a => a.id == animalId) : null;
        const title = animal ? 'Tier bearbeiten' : 'Neues Tier anlegen';
        const placeholderName = animal ? '' : funnyAnimalNames[Math.floor(Math.random() * funnyAnimalNames.length)];
        const sponsorsOptions = state.sponsors.map(s => `<option value="${s.id}" ${animal && animal.sponsorId == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
    
        let imageUrl = '';
        if (animal && animal.hasCustomImage) {
            try {
                const blob = await getImage(animal.id);
                if (blob) {
                    imageUrl = createManagedObjectURL(blob);
                }
            } catch (e) {
                console.error(e);
            }
        } else if (animal && animal.imageUrl) {
            imageUrl = animal.imageUrl;
        }
    
        const content = `
            <h2 class="text-3xl font-bold mb-4">${title}</h2>
            <form id="animal-edit-form" class="space-y-4">
                <input type="hidden" name="id" value="${animal ? animal.id : ''}">
                <label class="block font-semibold">Name</label>
                <input type="text" name="name" class="w-full p-2 border rounded-lg" value="${animal ? animal.name : ''}" placeholder="${placeholderName}" required>
                <label class="block font-semibold">Tierart</label>
                <select name="species" class="w-full p-2 border rounded-lg">
                    <option value="chicken" ${animal && animal.species === 'chicken' ? 'selected' : ''}>Huhn</option>
                    <option value="duck" ${animal && animal.species === 'duck' ? 'selected' : ''}>Ente</option>
                </select>
                <label class="block font-semibold">Fu√üring-Kennzeichnung</label>
                <div class="flex items-center gap-2 mt-1">
                    <select name="ringColor" class="w-1/2 p-2 border rounded-lg">
                        <option value="">Keine Farbe</option>
                        <option value="red" ${animal && animal.ringColor === 'red' ? 'selected' : ''}>Rot</option>
                        <option value="blue" ${animal && animal.ringColor === 'blue' ? 'selected' : ''}>Blau</option>
                        <option value="green" ${animal && animal.ringColor === 'green' ? 'selected' : ''}>Gr√ºn</option>
                        <option value="yellow" ${animal && animal.ringColor === 'yellow' ? 'selected' : ''}>Gelb</option>
                        <option value="black" ${animal && animal.ringColor === 'black' ? 'selected' : ''}>Schwarz</option>
                        <option value="white" ${animal && animal.ringColor === 'white' ? 'selected' : ''}>Wei√ü</option>
                    </select>
                    <input type="number" name="ringCount" min="0" placeholder="Anzahl" class="w-1/2 p-2 border rounded-lg" value="${animal && animal.ringCount ? animal.ringCount : '0'}">
                </div>
                <label class="block font-semibold">Pate</label>
                <select name="sponsorId" class="w-full p-2 border rounded-lg">
                    <option value="">Kein Pate</option>
                    ${sponsorsOptions}
                </select>
                <label class="block font-semibold">Foto</label>
                <input type="file" name="image" accept="image/*" class="hidden" id="image-input">
                <div class="flex gap-2 mt-1">
                    <button type="button" id="take-photo" class="flex-1 bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">üì∏ Foto aufnehmen</button>
                    <button type="button" id="upload-photo" class="flex-1 bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">üìÅ Datei hochladen</button>
                </div>
                <div id="image-preview-container" class="mt-2">${imageUrl ? `<img src="${imageUrl}" class="h-20 w-20 object-cover rounded-full">` : ''}</div>
                <div class="pt-4">
                    <button type="submit" id="save-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed" ${animal ? '' : 'disabled'}>Speichern</button>
                </div>
            </form>`;
    
        openModal(content, modal => {
            const saveBtn = modal.querySelector('#save-btn');
            modal.querySelector('form').addEventListener('input', () => saveBtn.disabled = false);
            setupImageUploader(modal, saveBtn);
            modal.querySelector('#animal-edit-form').addEventListener('submit', handleAnimalFormSubmit);
        });
    }
    
    async function renderEditSponsorModal(sponsorId = null) {
        activeEditSession = {};
        const sponsor = sponsorId ? state.sponsors.find(s => s.id == sponsorId) : null;
        const title = sponsor ? 'Pate bearbeiten' : 'Neuen Paten anlegen';
        const placeholderName = sponsor ? '' : funnySponsorNames[Math.floor(Math.random() * funnySponsorNames.length)];
        
        const availableAnimals = state.animals.filter(animal => animal.sponsorId === null || (sponsor && animal.sponsorId === sponsor.id));
        const animalCheckboxes = availableAnimals.map(animal => {
            const isChecked = sponsor && animal.sponsorId === sponsor.id;
            return `<label class="flex items-center space-x-2"><input type="checkbox" name="animalIds" value="${animal.id}" ${isChecked ? 'checked' : ''} class="rounded"><span>${animal.name} (${animal.species === 'chicken' ? 'Huhn' : 'Ente'})</span></label>`;
        }).join('');
    
        let imageUrl = '';
        if (sponsor && sponsor.hasCustomImage) {
            try {
                const blob = await getImage(sponsor.id);
                if (blob) {
                    imageUrl = createManagedObjectURL(blob);
                }
            } catch (e) {
                console.error(e);
            }
        }
    
        const content = `
            <h2 class="text-3xl font-bold mb-4">${title}</h2>
            <form id="sponsor-edit-form" class="space-y-4">
                <input type="hidden" name="id" value="${sponsor ? sponsor.id : ''}">
                <label class="block font-semibold">Name des Paten</label>
                <input type="text" name="name" class="w-full p-2 border rounded-lg" value="${sponsor ? sponsor.name : ''}" placeholder="${placeholderName}" required>
                <label class="block font-semibold">Patenschaftsmodell</label>
                <select name="level" class="w-full p-2 border rounded-lg">
                    <option value="Silber" ${sponsor && sponsor.level === 'Silber' ? 'selected' : ''}>Silber</option>
                    <option value="Gold" ${sponsor && sponsor.level === 'Gold' ? 'selected' : ''}>Gold</option>
                    <option value="King Edition" ${sponsor && sponsor.level === 'King Edition' ? 'selected' : ''}>King Edition</option>
                </select>
                <label class="block font-semibold">Zugeordnete Tiere</label>
                <div class="max-h-40 overflow-y-auto border rounded-lg p-2 space-y-1 mt-1">
                    ${animalCheckboxes || '<p class="text-gray-500">Keine Tiere vorhanden.</p>'}
                </div>
                <label class="block font-semibold">Foto des Paten (optional)</label>
                <input type="file" name="image" accept="image/*" class="hidden" id="image-input">
                <div class="flex gap-2 mt-1">
                    <button type="button" id="take-photo" class="flex-1 bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">üì∏ Foto aufnehmen</button>
                    <button type="button" id="upload-photo" class="flex-1 bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">üìÅ Datei hochladen</button>
                </div>
                <div id="image-preview-container" class="mt-2">${imageUrl ? `<img src="${imageUrl}" class="h-20 w-20 object-cover rounded-full">` : ''}</div>
                <div class="pt-4">
                    <button type="submit" id="save-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed" ${sponsor ? '' : 'disabled'}>Speichern</button>
                </div>
            </form>`;
    
        openModal(content, modal => {
            const saveBtn = modal.querySelector('#save-btn');
            modal.querySelector('form').addEventListener('input', () => saveBtn.disabled = false);
            setupImageUploader(modal, saveBtn);
            modal.querySelector('#sponsor-edit-form').addEventListener('submit', handleSponsorFormSubmit);
        });
    }
    
    // --- DATA HANDLING ---
    function cleanupAndCloseModal() {
        activeEditSession = {}; // Clear session data, including temporary newImageBlob reference
        history.back(); // Triggers popstate listener to close modal and revoke object URLs
    }

    function handleEggFormSubmit(e) {
        e.preventDefault();
        const chickenCount = parseInt(document.getElementById('chicken-eggs').value) || 0;
        const duckCount = parseInt(document.getElementById('duck-eggs').value) || 0;
        const today = getFormattedDate(new Date());
        
        const logIndex = state.eggLogs.findIndex(l => l.date === today);
        
        if (logIndex > -1) {
            state.eggLogs[logIndex].chicken = chickenCount;
            state.eggLogs[logIndex].duck = duckCount;
        } else {
            state.eggLogs.push({ date: today, chicken: chickenCount, duck: duckCount });
        }
        
        saveState();
        renderDashboard();
        e.target.reset();
    }
    
    async function handleAddPastEggLogSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const date = form.elements.date.value;
        const chickenCount = parseInt(form.elements.chicken.value) || 0;
        const duckCount = parseInt(form.elements.duck.value) || 0;

        if (!date) {
            showAlert("Bitte w√§hle ein Datum aus.");
            return;
        }

        const existingLogIndex = state.eggLogs.findIndex(log => log.date === date);

        if (existingLogIndex > -1) {
            const confirmed = await showConfirmation(`F√ºr den ${new Date(date).toLocaleDateString('de-DE')} existiert bereits ein Eintrag. M√∂chtest du ihn √ºberschreiben?`);
            if (!confirmed) {
                return;
            }
            state.eggLogs[existingLogIndex].chicken = chickenCount;
            state.eggLogs[existingLogIndex].duck = duckCount;
        } else {
            state.eggLogs.push({ date: date, chicken: chickenCount, duck: duckCount });
        }

        await saveState();
        history.back(); // Close the add-past-log modal
        renderEggModal(); // Re-render the main egg log modal
        showToast('Eintrag erfolgreich gespeichert!');
    }

    async function handleAnimalFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const id = formData.get('id') ? parseInt(formData.get('id')) : null;
        const newImageBlob = activeEditSession.newImageBlob;
        const name = (formData.get('name')).trim();
        if (!name) return showAlert("Der Name darf nicht leer sein.");
        const ringColor = formData.get('ringColor');
        const ringCount = parseInt(formData.get('ringCount')) || 0;

        if (ringColor && ringCount > 0 && state.animals.find(a => a.id !== id && a.ringColor === ringColor && a.ringCount === ringCount)) { return showAlert(`FEHLER: Diese Ring-Kennzeichnung ist bereits vergeben.`); }
        if (state.animals.find(a => a.id !== id && a.name.toLowerCase() === name.toLowerCase())) { return showAlert(`Ein Tier mit dem Namen '${name}' existiert bereits.`); }

        let animal;
        if (id) {
            animal = state.animals.find(a => a.id === id);
        } else {
            animal = { id: Date.now(), createdAt: Date.now(), name: '', species: 'chicken', sponsorId: null, ringColor: '', ringCount: 0, hasCustomImage: false };
            state.animals.push(animal);
        }

        animal.name = name;
        animal.species = formData.get('species');
        animal.sponsorId = formData.get('sponsorId') ? parseInt(formData.get('sponsorId')) : null;
        animal.ringColor = ringColor;
        animal.ringCount = ringCount;
        if (!id && !newImageBlob) {
            animal.hasCustomImage = false;
            animal.imageUrl = `https://placehold.co/300x200/cccccc/4A2E2E?text=${animal.name}`;
        }
        
        if (newImageBlob) {
            try {
                await saveImage(animal.id, newImageBlob);
                animal.hasCustomImage = true;
                delete animal.imageUrl;
            } catch (error) {
                console.error("Image save error:", error);
                showAlert("Profildaten gespeichert, aber das Bild konnte nicht gesichert werden.");
            }
        }
        
        await saveState();
        cleanupAndCloseModal();
        renderDashboard();
        if (document.querySelector('#animal-search')) renderAnimalModal();
    }

    async function handleSponsorFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const id = formData.get('id') ? parseInt(formData.get('id')) : null;
        const newImageBlob = activeEditSession.newImageBlob;
        const assignedAnimalIds = Array.from(formData.getAll('animalIds')).map(id => parseInt(id));
        const name = (formData.get('name')).trim();
        if (!name) return showAlert("Der Name darf nicht leer sein.");

        let sponsor;
        if (id) {
            sponsor = state.sponsors.find(s => s.id === id);
        } else {
            sponsor = { id: Date.now(), createdAt: Date.now(), name: '', level: 'Silber', hasCustomImage: false };
            state.sponsors.push(sponsor);
        }
        
        sponsor.name = name;
        sponsor.level = formData.get('level');
        if (!id && !newImageBlob) {
            sponsor.hasCustomImage = false;
        }

        state.animals.forEach(animal => {
            if (animal.sponsorId === sponsor.id && !assignedAnimalIds.includes(animal.id)) { animal.sponsorId = null; }
            if (assignedAnimalIds.includes(animal.id)) { animal.sponsorId = sponsor.id; }
        });
        
        if (newImageBlob) {
            try {
                await saveImage(sponsor.id, newImageBlob);
                sponsor.hasCustomImage = true;
            } catch (error) {
                console.error("Image save error:", error);
                showAlert("Patendaten gespeichert, aber das Bild konnte nicht gesichert werden.");
            }
        }
        
        await saveState();
        cleanupAndCloseModal();
        renderDashboard();
        if (document.querySelector('#sponsor-search')) renderSponsorModal();
    }

    async function deleteAnimal(animalId, fromDetail = false) {
        if (await showConfirmation('Bist du sicher, dass du dieses Tier l√∂schen m√∂chtest?')) {
            const animal = state.animals.find(a => a.id == animalId);
            if (animal && animal.hasCustomImage) {
                await deleteImage(animalId);
            }
            state.animals = state.animals.filter(a => a.id != animalId);
            await saveState();
            renderDashboard();
            if (fromDetail) {
                history.back();
            } else {
                renderAnimalModal();
            }
        }
    }
    
    async function deleteSponsor(sponsorId, fromDetail = false) {
        if (await showConfirmation('Bist du sicher? Zugeordnete Tiere verlieren ihre Patenschaft.')) {
            const sponsor = state.sponsors.find(s => s.id == sponsorId);
            if (sponsor && sponsor.hasCustomImage) {
                await deleteImage(sponsorId);
            }
            state.sponsors = state.sponsors.filter(s => s.id != sponsorId);
            state.animals.forEach(animal => {
                if (animal.sponsorId == sponsorId) {
                    animal.sponsorId = null;
                }
            });
            await saveState();
            renderDashboard();
            if (fromDetail) {
                history.back();
            } else {
                renderSponsorModal();
            }
        }
    }
    
    async function deleteAllData() {
        const confirmed = await showConfirmation('ACHTUNG: Bist du absolut sicher? Alle Tier-, Paten- und Eierdaten werden unwiderruflich gel√∂scht. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.');
        if (confirmed) {
            const animalImageIds = state.animals.filter(a => a.hasCustomImage).map(a => a.id);
            const sponsorImageIds = state.sponsors.filter(s => s.hasCustomImage).map(s => s.id);
            const allImageIds = [...animalImageIds, ...sponsorImageIds];

            state.animals = [];
            state.sponsors = [];
            state.eggLogs = [];
            
            try {
                await Promise.all(allImageIds.map(id => deleteImage(id)));
            } catch (error) {
                console.error("Error deleting images from IndexedDB:", error);
                showAlert("Daten gel√∂scht, aber es gab ein Problem beim Bereinigen der Bilder.");
            }

            await saveState(false);
            renderDashboard();
            history.back();
            showToast("Alle Daten wurden gel√∂scht.");
        }
    }
    
    async function exportData() {
        const animalsWithImages = await Promise.all(state.animals.map(async animal => {
            const copy = { ...animal };
            if (copy.hasCustomImage) {
                const blob = await getImage(copy.id);
                if (blob) {
                    copy.imageUrl = await blobToBase64(blob);
                }
            }
            return copy;
        }));
    
        const sponsorsWithImages = await Promise.all(state.sponsors.map(async sponsor => {
            const copy = { ...sponsor };
            if (copy.hasCustomImage) {
                const blob = await getImage(copy.id);
                if (blob) {
                    copy.imageUrl = await blobToBase64(blob);
                }
            }
            return copy;
        }));
    
        const animalSheet = XLSX.utils.json_to_sheet(animalsWithImages);
        const sponsorSheet = XLSX.utils.json_to_sheet(sponsorsWithImages);
        const eggSheet = XLSX.utils.json_to_sheet(state.eggLogs);
    
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, animalSheet, "Tiere");
        XLSX.utils.book_append_sheet(workbook, sponsorSheet, "Paten");
        XLSX.utils.book_append_sheet(workbook, eggSheet, "Eier");
    
        XLSX.writeFile(workbook, "Chicken-App-Daten.xlsx");
        showToast("Daten werden exportiert!");
    }
    
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
    
        const reader = new FileReader();
        reader.onload = async e => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
    
            try {
                const importedAnimals = XLSX.utils.sheet_to_json(workbook.Sheets['Tiere']);
                const importedSponsors = XLSX.utils.sheet_to_json(workbook.Sheets['Paten']);
    
                await Promise.all(importedAnimals.map(async (animal) => {
                    if (animal.imageUrl && animal.imageUrl.startsWith('data:image')) {
                        const blob = await base64ToBlob(animal.imageUrl);
                        await saveImage(animal.id, blob);
                        animal.hasCustomImage = true;
                        delete animal.imageUrl;
                    }
                }));
    
                await Promise.all(importedSponsors.map(async (sponsor) => {
                    if (sponsor.imageUrl && sponsor.imageUrl.startsWith('data:image')) {
                        const blob = await base64ToBlob(sponsor.imageUrl);
                        await saveImage(sponsor.id, blob);
                        sponsor.hasCustomImage = true;
                        delete sponsor.imageUrl;
                    }
                }));
    
                state.animals = importedAnimals;
                state.sponsors = importedSponsors;
                state.eggLogs = XLSX.utils.sheet_to_json(workbook.Sheets['Eier']);
    
                await saveState(false);
                renderDashboard();
                history.back();
                showToast("Daten erfolgreich importiert!");
    
            } catch (err) {
                console.error("Import Error:", err);
                showAlert("Fehler beim Importieren der Datei. Stellen Sie sicher, dass die Bl√§tter 'Tiere', 'Paten' und 'Eier' existieren und korrekt formatiert sind.");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // --- THEME & INIT ---
    function applyTheme(theme){if(theme==='dark'){document.documentElement.classList.add('dark');}else{document.documentElement.classList.remove('dark');}}
    
    async function toggleTheme(){
        const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        try {
            await saveDataToDB('appSettings', 'theme', newTheme);
            applyTheme(newTheme);
        } catch (error) {
            console.error("Failed to save theme:", error);
            showAlert("Theme konnte nicht gespeichert werden.");
        }
    }

    document.getElementById('egg-form').addEventListener('submit', handleEggFormSubmit);
    document.getElementById('card-animals').addEventListener('click', () => renderAnimalModal());
    document.getElementById('card-sponsors').addEventListener('click', () => renderSponsorModal());
    document.getElementById('card-eggs').addEventListener('click', () => renderEggModal());
    document.getElementById('card-data').addEventListener('click', () => renderFileModal());
    document.getElementById('card-add-new').addEventListener('click', renderAddNewModal);
    document.getElementById('card-settings').addEventListener('click', renderSettingsModal);
    document.getElementById('card-unsponsored').addEventListener('click', () => renderAnimalModal({ sponsorFilter: 'none' }));
    document.getElementById('add-animal-shortcut').addEventListener('click', (e) => { e.stopPropagation(); renderEditAnimalModal(); });
    document.getElementById('add-sponsor-shortcut').addEventListener('click', (e) => { e.stopPropagation(); renderEditSponsorModal(); });
    document.getElementById('nav-overview').addEventListener('click', () => { if (isModalOpen) history.back(); });
    document.getElementById('nav-animals').addEventListener('click', () => renderAnimalModal());
    document.getElementById('nav-sponsors').addEventListener('click', () => renderSponsorModal());
    document.getElementById('nav-eggs').addEventListener('click', () => renderEggModal());
    document.getElementById('nav-data').addEventListener('click', () => renderFileModal());
    document.getElementById('nav-unsponsored').addEventListener('click', () => renderAnimalModal({ sponsorFilter: 'none' }));
    document.getElementById('nav-add-new').addEventListener('click', renderAddNewModal);
    document.getElementById('nav-settings').addEventListener('click', renderSettingsModal);
    
    async function init() {
        try {
            await initDB();
            const [theme] = await Promise.all([
                loadDataFromDB('appSettings', 'theme').catch(() => 'light'),
                loadState()
            ]);

            if (state.animals.length === 0 && state.sponsors.length === 0) {
                await addSampleData();
            }

            await loadDashboardOrder();
            renderDashboard();
            applyTheme(theme || 'light');
            startAutoSaveTimer();
            
        } catch (error) {
            console.error("Critical Error on Initialization:", error);
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; background-color: #fee2e2; color: #b91c1c;"><h1 style="font-size: 1.5rem; font-weight: bold;">Kritischer Fehler</h1><p style="margin-top: 1rem;">Die App konnte nicht initialisiert werden. Dies kann im privaten Browsing-Modus passieren.</p></div>`;
            return; 
        }
    }

    async function addSampleData() {
        console.log("Adding sample data...");
        const sampleSponsorImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI2NjY2NjYyIvPjxjaXJjbGUgY3g9IjM1IiBjeT0iNDAiIHI9IjUiIGZpbGw9IiMzMzMiLz48Y2lyY2xlIGN4PSI2NSIgY3k9IjQwIiByPSI1IiBmaWxsPSIjMzMzIi8+PHBhdGggZD0iTTMwIDY1IFEgNTAgODAgNzAgNjUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI1IiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=';
        const sampleChickenImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjYwIiByPSIzMCIgZmlsbD0iI0EwNTIyRCIvPjxjaXJjbGUgY3g9Ijc1IiBjeT0iNDAiIHI9IjE1IiBmaWxsPSIjQTA1MjJEIi8+PHBhdGggZD0iTTcwIDIwIFEgNzUgMTAgODAgMjAgVCA5MCAyMCIgZmlsbD0iI0ZGRDUwMCIvPjxwb2x5Z29uIHBvaW50cz0iODUsNDUgOTUsNTAgODUsNTUiIGZpbGw9IiNGRkE1MCIvPjxjaXJjbGUgY3g9IjgwIiBjeT0iMzgiIHI9IjMiIGZpbGw9IiMwMDAiLz48L3N2Zz4=';
        const sampleDuckImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjYwIiByPSIzMCIgZmlsbD0iI0ZGRDcwMCIvPjxjaXJjbGUgY3g9Ijc1IiBjeT0iNDAiIHI9IjE1IiBmaWxsPSIjRkZENzAwIi8+PHBvbHlnb24gcG9pbnRzPSI4NSw0NSAxMDAsNDggMTAwLDUyIDg1LDU1IiBmaWxsPSIjRkZBNTAwIi8+PGNpcmNsZSBjeD0iODAiIGN5PSIzOCIgcj0iMyIgZmlsbD0iIzAwMCIvPjwvc3ZnPg==';
        
        const imageSavePromises = [];
        const sponsors = [];
        for (let i = 1; i <= 20; i++) {
            const sponsor = {
                id: Date.now() + i, createdAt: Date.now() + i,
                name: `Pate Nr. ${i}`, level: ["Silber", "Gold", "King Edition"][i % 3],
                hasCustomImage: true
            };
            imageSavePromises.push(
                base64ToBlob(sampleSponsorImg).then(blob => saveImage(sponsor.id, blob))
            );
            sponsors.push(sponsor);
        }
        state.sponsors = sponsors;

        const animals = [];
        let animalIdCounter = 100;
        for (let i = 1; i <= 30; i++) {
            const animal = {
                id: Date.now() + animalIdCounter++, createdAt: Date.now() + animalIdCounter,
                name: `Huhn ${i}`, species: "chicken", sponsorId: null,
                ringColor: "", ringCount: 0, hasCustomImage: true
            };
            imageSavePromises.push(
                base64ToBlob(sampleChickenImg).then(blob => saveImage(animal.id, blob))
            );
            animals.push(animal);
        }
        for (let i = 1; i <= 7; i++) {
            const animal = {
                id: Date.now() + animalIdCounter++, createdAt: Date.now() + animalIdCounter,
                name: `Ente ${i}`, species: "duck", sponsorId: null,
                ringColor: "", ringCount: 0, hasCustomImage: true
            };
            imageSavePromises.push(
                base64ToBlob(sampleDuckImg).then(blob => saveImage(animal.id, blob))
            );
            animals.push(animal);
        }
        state.animals = animals;
        
        const chickens = state.animals.filter(a => a.species === 'chicken');
        const ducks = state.animals.filter(a => a.species === 'duck');
        let sponsorIndex = 0;

        for (let i = 0; i < 17; i++) {
            chickens[i].sponsorId = state.sponsors[sponsorIndex % state.sponsors.length].id;
            sponsorIndex++;
        }
        for (let i = 0; i < 4; i++) {
            ducks[i].sponsorId = state.sponsors[sponsorIndex % state.sponsors.length].id;
            sponsorIndex++;
        }

        const today = new Date();
        for (let i = 0; i < 30; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            state.eggLogs.push({
                date: getFormattedDate(date),
                chicken: Math.floor(Math.random() * (chickens.length * 0.8)),
                duck: Math.floor(Math.random() * (ducks.length * 0.7))
            });
        }
        
        await Promise.all(imageSavePromises);
        await saveState(false);
        console.log("Sample data with images added and saved.");
    }

    init();
});
    </script>
</body>
</html>